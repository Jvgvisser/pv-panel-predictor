<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV Predictor - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card { border: 1px solid #eef0f2; padding: 20px; border-radius: 10px; margin-bottom: 25px; background: #fff; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Grafiek Toggle Knoppen */
        .view-toggle button { background: #fff; border: 1px solid #d1d9e0; padding: 8px 16px; cursor: pointer; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .view-toggle button.active { background: #1a73e8; color: white; border-color: #1a73e8; }
        
        /* Tabel styling */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        th, td { padding: 12px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; }
        th { background: #f8f9fa; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input { padding: 8px; border: 1px solid #dadce0; border-radius: 4px; width: 100%; box-sizing: border-box; outline: none; }
        input:focus { border-color: #1a73e8; }
        
        /* Knoppen */
        .btn { cursor: pointer; border: none; border-radius: 4px; padding: 8px 12px; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { opacity: 0.85; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-green { background: #34a853; color: white; }
        .btn-orange { background: #fbbc05; color: white; }
        .btn-red { background: #ea4335; color: white; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { height: 450px; position: relative; }
    </style>
</head>
<body>

<div class="container">
    <div class="chart-header">
        <h1>‚òÄÔ∏è Solar Forecast Dashboard</h1>
        <div class="view-toggle">
            <button id="btn-2d" class="active" onclick="setView(2)">2 Dagen</button>
            <button id="btn-7d" onclick="setView(7)">7 Dagen</button>
        </div>
    </div>

    <div class="card">
        <h2 id="chart-title">Totaal Voorspelling (kWh)</h2>
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>Paneel Management</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">ID</th>
                        <th>Naam</th>
                        <th>HA Entity ID</th>
                        <th style="width: 80px;">Wp</th>
                        <th style="width: 70px;">Hoek</th>
                        <th style="width: 70px;">Azi</th>
                        <th style="text-align: center;">Acties</th>
                    </tr>
                </thead>
                <tbody id="panels-body"></tbody>
            </table>
        </div>
        <button class="btn btn-blue" style="margin-top:20px;" onclick="addNewPanelRow()">‚ûï Nieuw Paneel Toevoegen</button>
    </div>

    <div class="card" style="background: #f8f9fa; border: 1px dashed #ccc;">
        <h3>Systeem Instellingen</h3>
        <div class="grid">
            <div>
                <label style="font-size: 0.8em; font-weight: bold;">Home Assistant URL</label>
                <input type="text" id="ha_url" placeholder="http://192.168.1.xxx:8123">
            </div>
            <div>
                <label style="font-size: 0.8em; font-weight: bold;">Long-Lived Access Token</label>
                <input type="password" id="ha_token" placeholder="v3_eyJhbGciOiJIUzI1NiI...">
            </div>
        </div>
        <button class="btn btn-green" style="margin-top:15px; width:100%; height: 45px;" onclick="saveGlobalConfig()">üíæ Sla HA-configuratie op voor alles</button>
    </div>
</div>

<script>
let mainChart;
let currentViewDays = 2;

async function init() {
    await loadSettings();
    await refreshData();
}

function setView(days) {
    currentViewDays = days;
    document.getElementById('btn-2d').classList.toggle('active', days === 2);
    document.getElementById('btn-7d').classList.toggle('active', days === 7);
    refreshData();
}

async function loadSettings() {
    const config = await fetch('/api/config').then(r => r.json());
    document.getElementById('ha_url').value = config.ha_base_url || '';
    document.getElementById('ha_token').value = config.ha_token || '';

    const panels = await fetch('/api/panels').then(r => r.json());
    const body = document.getElementById('panels-body');
    body.innerHTML = '';
    panels.sort((a,b) => a.panel_id.localeCompare(b.panel_id)).forEach(p => {
        const row = body.insertRow();
        row.innerHTML = `
            <td><strong>${p.panel_id}</strong></td>
            <td><input type="text" class="p-name" value="${p.friendly_name || ''}"></td>
            <td><input type="text" class="p-entity" value="${p.entity_id}"></td>
            <td><input type="number" class="p-wp" value="${p.watt_peak || 400}"></td>
            <td><input type="number" class="p-tilt" value="${p.tilt_deg}"></td>
            <td><input type="number" class="p-azi" value="${p.azimuth_deg}"></td>
            <td style="text-align: center;">
                <button class="btn btn-green" title="Opslaan" onclick="savePanel('${p.panel_id}', this)">üíæ</button>
                <button class="btn btn-orange" title="Train Model" onclick="trainPanel('${p.panel_id}')">üéì</button>
                <button class="btn btn-blue" title="Toon dit paneel" onclick="showSinglePanel('${p.panel_id}')">üìà</button>
                <button class="btn btn-red" title="Verwijder" onclick="deletePanel('${p.panel_id}')">üóëÔ∏è</button>
            </td>
        `;
    });
}

async function refreshData() {
    const panels = await fetch('/api/panels').then(r => r.json());
    let combined = {};

    for (const p of panels) {
        try {
            const res = await fetch(`/api/panels/${p.panel_id}/predict?days=${currentViewDays}`);
            const data = await res.json();
            data.forecast.forEach(pt => {
                combined[pt.time] = (combined[pt.time] || 0) + pt.kwh;
            });
        } catch(e) { console.error("Fout bij laden van " + p.panel_id, e); }
    }
    document.getElementById('chart-title').innerText = `Totaal Voorspelling (Alle Panelen) - ${currentViewDays} Dagen`;
    updateChart(combined, "Gecombineerd Totaal (kWh)", "#1a73e8");
}

async function showSinglePanel(id) {
    const res = await fetch(`/api/panels/${id}/predict?days=${currentViewDays}`);
    const data = await res.json();
    let single = {};
    data.forecast.forEach(pt => { single[pt.time] = pt.kwh; });
    document.getElementById('chart-title').innerText = `Voorspelling voor: ${id}`;
    updateChart(single, `Opbrengst ${id} (kWh)`, "#fd7e14");
}

async function trainPanel(id) {
    if(!confirm(`Wil je de training starten voor ${id}? Dit gebruikt de data van de laatste 30 dagen.`)) return;
    const res = await fetch(`/api/panels/${id}/train?days=30`, {method: 'POST'});
    const data = await res.json();
    alert(`Training succesvol!\nNauwkeurigheid (R2): ${data.metrics.r2.toFixed(3)}\nData-punten: ${data.rows}`);
    refreshData();
}

async function savePanel(id, btn) {
    const row = btn.parentElement.parentElement;
    const data = {
        panel_id: id,
        friendly_name: row.querySelector('.p-name').value,
        entity_id: row.querySelector('.p-entity').value,
        watt_peak: parseFloat(row.querySelector('.p-wp').value),
        tilt_deg: parseFloat(row.querySelector('.p-tilt').value),
        azimuth_deg: parseFloat(row.querySelector('.p-azi').value),
        latitude: 52.0, // Vul hier je eigen lat in
        longitude: 5.0,  // Vul hier je eigen lon in
        ha_base_url: document.getElementById('ha_url').value,
        ha_token: document.getElementById('ha_token').value,
        scale_to_kwh: 0.001
    };
    
    await fetch('/api/panels', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    alert('Paneel ' + id + ' opgeslagen!');
}

async function saveGlobalConfig() {
    const data = {
        ha_base_url: document.getElementById('ha_url').value,
        ha_token: document.getElementById('ha_token').value
    };
    await fetch('/api/config/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    alert('Instellingen toegepast op alle panelen!');
    loadSettings();
}

async function deletePanel(id) {
    if(confirm('Weet je zeker dat je dit paneel wilt verwijderen?')) {
        await fetch(`/api/panels/${id}`, { method: 'DELETE' });
        loadSettings();
    }
}

function addNewPanelRow() {
    const body = document.getElementById('panels-body');
    const newId = "p" + (body.rows.length + 1).toString().padStart(2, '0');
    const row = body.insertRow();
    row.innerHTML = `
        <td><strong>${newId}</strong></td>
        <td><input type="text" class="p-name" value="Nieuw Paneel"></td>
        <td><input type="text" class="p-entity" value="sensor.solar_yield"></td>
        <td><input type="number" class="p-wp" value="400"></td>
        <td><input type="number" class="p-tilt" value="35"></td>
        <td><input type="number" class="p-azi" value="0"></td>
        <td><button class="btn btn-green" onclick="savePanel('${newId}', this)">üíæ</button></td>
    `;
}

function updateChart(dataDict, label, color) {
    const labels = Object.keys(dataDict).sort();
    const values = labels.map(l => dataDict[l]);
    const timeLabels = labels.map(l => {
        const d = new Date(l);
        const day = d.getDate();
        const month = d.getMonth() + 1;
        return `${d.getHours()}:00 (${day}-${month})`;
    });

    if (mainChart) mainChart.destroy();
    mainChart = new Chart(document.getElementById('mainChart'), {
        type: 'bar',
        data: {
            labels: timeLabels,
            datasets: [{
                label: label,
                data: values,
                backgroundColor: color,
                borderRadius: 5,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Opbrengst (kWh)' } },
                x: { ticks: { maxRotation: 45, minRotation: 45 } }
            }
        }
    });
}

init();
</script>
</body>
</html>