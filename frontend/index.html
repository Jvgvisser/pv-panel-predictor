<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV Dashboard Delft - Bartoutszate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .panel-card:hover { transform: translateY(-2px); transition: 0.2s; }
        .active-panel { border-color: #2563eb; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border-l-8 border-blue-600">
            <div>
                <h1 id="mainTitle" class="text-2xl font-bold text-gray-800">Totaaloverzicht Bartoutszate 42</h1>
                <p id="subTitle" class="text-blue-600 font-medium">Gecombineerde data van 28 panelen</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-2">
                <button onclick="loadTotalView()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition">
                    üè† Toon Totaal
                </button>
                <button onclick="trainAll()" class="bg-gray-800 hover:bg-black text-white py-2 px-4 rounded-lg shadow transition">
                    üöÄ Train Alles
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-lg font-bold mb-4 text-gray-700">Verwacht Vermogen (kWh per uur)</h3>
                <div style="height: 300px;"><canvas id="hourlyChart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-lg font-bold mb-4 text-gray-700">Dagopbrengst (kWh)</h3>
                <div style="height: 300px;"><canvas id="dailyChart"></canvas></div>
            </div>
        </div>

        <h3 class="text-xl font-bold text-gray-800 mb-4">Individuele Panelen <span class="text-sm font-normal text-gray-500">(Klik voor details)</span></h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 lg:grid-cols-10 gap-3" id="panelGrid">
            </div>
    </div>

    <script>
        let hourlyChart, dailyChart;
        let allPanels = [];
        let allForecasts = {}; // Buffer om data op te slaan zodat switchen snel gaat

        async function init() {
            const res = await fetch('/api/panels');
            const data = await res.json();
            allPanels = data.panels || data;
            
            renderPanelGrid();
            await loadTotalView();
        }

        function renderPanelGrid() {
            const grid = document.getElementById('panelGrid');
            grid.innerHTML = '';
            allPanels.forEach(p => {
                const card = document.createElement('div');
                card.id = `card-${p.panel_id}`;
                card.className = "panel-card bg-white p-3 rounded-lg border border-gray-200 text-center cursor-pointer shadow-sm";
                card.onclick = () => loadSinglePanelView(p.panel_id);
                card.innerHTML = `
                    <div class="text-sm font-bold text-gray-700">${p.panel_id}</div>
                    <div class="text-[10px] text-gray-400 uppercase mt-1">Bekijk paneel</div>
                `;
                grid.appendChild(card);
            });
        }

        async function loadTotalView() {
            document.getElementById('mainTitle').innerText = "Totaaloverzicht Bartoutszate 42";
            document.getElementById('subTitle').innerText = "Gecombineerde data van 28 panelen";
            
            // Reset actieve klassen in grid
            document.querySelectorAll('.panel-card').forEach(c => c.classList.remove('active-panel'));

            const combinedHourly = {};
            const combinedDaily = {};

            const promises = allPanels.map(async (p) => {
                const forecast = await getForecast(p.panel_id);
                forecast.forEach(f => {
                    combinedHourly[f.time] = (combinedHourly[f.time] || 0) + f.kwh;
                    const day = f.time.split('T')[0];
                    combinedDaily[day] = (combinedDaily[day] || 0) + f.kwh;
                });
            });

            await Promise.all(promises);
            updateCharts(combinedHourly, combinedDaily, '#2563eb', 'Totaal Systeem');
        }

        async function loadSinglePanelView(panelId) {
            document.getElementById('mainTitle').innerText = `Paneel ${panelId}`;
            document.getElementById('subTitle').innerText = `Individuele voorspelling voor ${panelId}`;
            
            // Markeer actieve kaart
            document.querySelectorAll('.panel-card').forEach(c => c.classList.remove('active-panel'));
            document.getElementById(`card-${panelId}`).classList.add('active-panel');

            const hourly = {};
            const daily = {};
            const forecast = await getForecast(panelId);
            
            forecast.forEach(f => {
                hourly[f.time] = f.kwh;
                const day = f.time.split('T')[0];
                daily[day] = (daily[day] || 0) + f.kwh;
            });

            updateCharts(hourly, daily, '#059669', `Paneel ${panelId}`);
        }

        async function getForecast(panelId) {
            if (allForecasts[panelId]) return allForecasts[panelId];
            try {
                const res = await fetch(`/api/panels/${panelId}/predict?days=7`);
                const data = await res.json();
                if (data.ok) {
                    allForecasts[panelId] = data.forecast;
                    return data.forecast;
                }
            } catch (e) { console.error(e); }
            return [];
        }

        function updateCharts(hourly, daily, color, label) {
            const hLabels = Object.keys(hourly).sort();
            const hValues = hLabels.map(l => hourly[l]);
            
            if (hourlyChart) hourlyChart.destroy();
            hourlyChart = new Chart(document.getElementById('hourlyChart'), {
                type: 'line',
                data: {
                    labels: hLabels.map(l => new Date(l).toLocaleString('nl-NL', {day:'numeric', month:'short', hour:'2-digit'})),
                    datasets: [{ label: label + ' (kWh)', data: hValues, borderColor: color, backgroundColor: color+'22', fill: true, tension: 0.3, pointRadius: 2 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const dLabels = Object.keys(daily).sort();
            const dValues = dLabels.map(d => daily[d]);

            if (dailyChart) dailyChart.destroy();
            dailyChart = new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: dLabels.map(d => new Date(d).toLocaleDateString('nl-NL', {weekday: 'short', day: 'numeric'})),
                    datasets: [{ label: 'Dag Totaal (kWh)', data: dValues, backgroundColor: color }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function trainAll() {
            const btn = event.target;
            btn.innerText = "‚è≥ Bezig...";
            for(let p of allPanels) {
                await fetch(`/api/panels/${p.panel_id}/train?days=365`, { method: 'POST' });
            }
            btn.innerText = "üöÄ Alles Getraind";
            allForecasts = {}; // Clear cache
            loadTotalView();
        }

        init();
    </script>
</body>
</html>