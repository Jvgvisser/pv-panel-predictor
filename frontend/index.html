<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV Predictor - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card { border: 1px solid #eef0f2; padding: 20px; border-radius: 10px; margin-bottom: 25px; background: #fff; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .view-toggle { display: flex; gap: 10px; }
        .view-toggle button { background: #fff; border: 1px solid #d1d9e0; padding: 8px 16px; cursor: pointer; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .view-toggle button.active { background: #1a73e8; color: white; border-color: #1a73e8; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        th, td { padding: 12px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; }
        th { background: #f8f9fa; color: #5f6368; text-transform: uppercase; }
        input { padding: 8px; border: 1px solid #dadce0; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .btn { cursor: pointer; border: none; border-radius: 4px; padding: 8px 12px; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-green { background: #34a853; color: white; }
        .btn-orange { background: #fbbc05; color: white; }
        .btn-red { background: #ea4335; color: white; }
        .btn-black { background: #202124; color: white; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { height: 350px; position: relative; margin-bottom: 20px; }
        #training-status { display: none; background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #1a73e8; }
        .progress-bar { height: 10px; background: #ddd; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #1a73e8; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <div class="chart-header">
        <h1>‚òÄÔ∏è Solar Forecast Dashboard</h1>
        <div class="view-toggle">
            <a href="/ui/evaluate.html" class="btn btn-black">üìä View Evaluation</a>
            <button id="btn-refresh" onclick="refreshData()">üîÑ Refresh Total</button>
            <button id="btn-2d" class="active" onclick="setView(2)">2 Days</button>
            <button id="btn-7d" onclick="setView(7)">7 Days</button>
        </div>
    </div>

    <div class="card">
        <h2 id="chart-title">Hourly Forecast Comparison (kWh)</h2>
        <div class="chart-container"><canvas id="mainChart"></canvas></div>
    </div>

    <div class="card">
        <h2 id="daily-chart-title">Daily Totals Comparison (kWh)</h2>
        <div class="chart-container"><canvas id="dailyChart"></canvas></div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Panel Management</h3>
            <button class="btn btn-black" onclick="trainAllPanels(365)">üöÄ Train All Models (365 Days)</button>
        </div>
        <div id="training-status">
            <div id="training-msg">Starting full system training...</div>
            <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr><th>ID</th><th>Friendly Name</th><th>HA Entity ID</th><th>Wp</th><th>Tilt</th><th>Azi</th><th style="text-align: center;">Actions</th></tr>
                </thead>
                <tbody id="panels-body"></tbody>
            </table>
        </div>
        <button class="btn btn-blue" style="margin-top:20px;" onclick="addNewPanelRow()">‚ûï Add New Panel</button>
    </div>

    <div class="card" style="background: #f8f9fa;">
        <h3>Global System & Location Settings</h3>
        <div class="grid">
            <div><label>HA URL</label><input type="text" id="ha_url"></div>
            <div><label>HA Token</label><input type="password" id="ha_token"></div>
            <div><label>Latitude</label><input type="number" id="latitude" step="any"></div>
            <div><label>Longitude</label><input type="number" id="longitude" step="any"></div>
        </div>
        <button class="btn btn-green" style="margin-top:15px; width:100%;" onclick="saveGlobalConfig()">üíæ Sync Settings & Location to All Panels</button>
    </div>
</div>

<script>
let mainChart, dailyChart;
let currentViewDays = 2;

async function init() {
    await loadSettings();
    await refreshData();
}

function setView(days) {
    currentViewDays = days;
    document.getElementById('btn-2d').classList.toggle('active', days === 2);
    document.getElementById('btn-7d').classList.toggle('active', days === 7);
    refreshData();
}

async function loadSettings() {
    const config = await fetch('/api/config').then(r => r.json());
    document.getElementById('ha_url').value = config.ha_base_url || '';
    document.getElementById('ha_token').value = config.ha_token || '';
    document.getElementById('latitude').value = config.latitude || 52.3676;
    document.getElementById('longitude').value = config.longitude || 4.9041;

    const panels = await fetch('/api/panels').then(r => r.json());
    const body = document.getElementById('panels-body');
    body.innerHTML = '';
    panels.sort((a,b) => a.panel_id.localeCompare(b.panel_id)).forEach(p => {
        const row = body.insertRow();
        row.innerHTML = `
            <td><strong>${p.panel_id}</strong></td>
            <td><input type="text" class="p-name" value="${p.friendly_name || ''}"></td>
            <td><input type="text" class="p-entity" value="${p.entity_id}"></td>
            <td><input type="number" class="p-wp" value="${p.watt_peak || 400}"></td>
            <td><input type="number" class="p-tilt" value="${p.tilt_deg}"></td>
            <td><input type="number" class="p-azi" value="${p.azimuth_deg}"></td>
            <td style="text-align: center;">
                <button class="btn btn-green" title="Save" onclick="savePanel('${p.panel_id}', this)">üíæ</button>
                <button class="btn btn-orange" title="Train 30D" onclick="trainPanel('${p.panel_id}', 30)">üéì</button>
                <button class="btn btn-blue" title="Show Chart" onclick="showSinglePanel('${p.panel_id}')">üìà</button>
                <button class="btn btn-red" title="Delete" onclick="deletePanel('${p.panel_id}')">üóëÔ∏è</button>
            </td>`;
    });
}

async function refreshData() {
    try {
        const [lgbRes, xgbRes] = await Promise.all([
            fetch(`/api/predict/total?days=7&model_type=lgbm`).then(r => r.json()),
            fetch(`/api/predict/total?days=7&model_type=xgb`).then(r => r.json())
        ]);
        
        let lgbMap = {}; lgbRes.forEach(p => lgbMap[p.time] = p.kwh);
        let xgbMap = {}; xgbRes.forEach(p => xgbMap[p.time] = p.kwh);
        
        updateChartsMulti(lgbMap, xgbMap, "Total System");
    } catch(e) { console.error("Refresh error:", e); }
}

async function showSinglePanel(id) {
    try {
        const [lgbRes, xgbRes] = await Promise.all([
            fetch(`/api/panels/${id}/predict?days=7&model_type=lgbm`).then(r => r.json()),
            fetch(`/api/panels/${id}/predict?days=7&model_type=xgb`).then(r => r.json())
        ]);

        let lgbMap = {}; lgbRes.forEach(p => lgbMap[p.time] = p.kwh);
        let xgbMap = {}; xgbRes.forEach(p => xgbMap[p.time] = p.kwh);
        
        updateChartsMulti(lgbMap, xgbMap, `Panel ${id}`);
    } catch(e) { console.error("Error loading panel:", e); }
}

function updateChartsMulti(lgbData, xgbData, labelPrefix) {
    const allLabels = Object.keys(lgbData).sort();
    if(allLabels.length === 0) return;

    const hourLabels = allLabels.slice(0, currentViewDays * 24);
    const hourTimeLabels = hourLabels.map(l => {
        const d = new Date(l);
        return `${d.getHours()}:00 (${d.getDate()}-${d.getMonth()+1})`;
    });

    const lgbValues = hourLabels.map(l => lgbData[l] || 0);
    const xgbValues = hourLabels.map(l => xgbData[l] || 0);

    // Bereken dagelijkse totalen voor de bar chart
    let dailyLGB = {}, dailyXGB = {};
    Object.keys(lgbData).forEach(l => {
        const d = new Date(l).toLocaleDateString('en-GB', { weekday:'short', day:'numeric'});
        dailyLGB[d] = (dailyLGB[d] || 0) + lgbData[l];
    });
    Object.keys(xgbData).forEach(l => {
        const d = new Date(l).toLocaleDateString('en-GB', { weekday:'short', day:'numeric'});
        dailyXGB[d] = (dailyXGB[d] || 0) + xgbData[l];
    });

    if (mainChart) mainChart.destroy();
    mainChart = new Chart(document.getElementById('mainChart'), {
        type: 'line',
        data: {
            labels: hourTimeLabels,
            datasets: [
                { label: "LGBM (Blauw)", data: lgbValues, borderColor: "#1a73e8", backgroundColor: "rgba(26,115,232,0.1)", fill: true, tension: 0.3 },
                { label: "XGBoost (Rood)", data: xgbValues, borderColor: "#ea4335", backgroundColor: "rgba(234,67,53,0.1)", fill: true, tension: 0.3 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    if (dailyChart) dailyChart.destroy();
    dailyChart = new Chart(document.getElementById('dailyChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(dailyLGB),
            datasets: [
                { label: "LGBM Daily", data: Object.values(dailyLGB), backgroundColor: "#1a73e8" },
                { label: "XGBoost Daily", data: Object.values(dailyXGB), backgroundColor: "#ea4335" }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });
}

async function savePanel(id, btn) {
    const row = btn.parentElement.parentElement;
    const data = {
        "panel_id": id,
        "friendly_name": row.querySelector('.p-name').value || "Panel " + id,
        "entity_id": row.querySelector('.p-entity').value,
        "watt_peak": parseFloat(row.querySelector('.p-wp').value) || 400.0,
        "tilt_deg": parseFloat(row.querySelector('.p-tilt').value) || 35.0,
        "azimuth_deg": parseFloat(row.querySelector('.p-azi').value) || 0.0,
        "latitude": parseFloat(document.getElementById('latitude').value), 
        "longitude": parseFloat(document.getElementById('longitude').value),
        "ha_base_url": document.getElementById('ha_url').value,
        "ha_token": document.getElementById('ha_token').value,
        "scale_to_kwh": 0.001
    };
    const response = await fetch('/api/panels', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    if(response.ok) { btn.innerText = "‚úÖ"; setTimeout(() => btn.innerText = "üíæ", 2000); }
}

async function trainAllPanels(days) {
    if(!confirm(`Start training ALL panels for ${days} days?`)) return;
    const statusDiv = document.getElementById('training-status');
    const msg = document.getElementById('training-msg');
    const fill = document.getElementById('progress-fill');
    statusDiv.style.display = 'block';
    const panels = await fetch('/api/panels').then(r => r.json());
    for(let i=0; i < panels.length; i++) {
        fill.style.width = ((i / panels.length) * 100) + "%";
        msg.innerText = `Training ${panels[i].panel_id}... [${i+1}/${panels.length}]`;
        await fetch(`/api/panels/${panels[i].panel_id}/train?days=${days}`, {method: 'POST'});
    }
    msg.innerText = "Success! All models trained.";
    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
    refreshData();
}

async function trainPanel(id, days) {
    alert(`Training ${id}...`);
    await fetch(`/api/panels/${id}/train?days=${days}`, {method: 'POST'});
    alert(`Finished ${id}`);
    refreshData();
}

async function saveGlobalConfig() {
    const data = { 
        ha_base_url: document.getElementById('ha_url').value, 
        ha_token: document.getElementById('ha_token').value,
        latitude: parseFloat(document.getElementById('latitude').value),
        longitude: parseFloat(document.getElementById('longitude').value)
    };
    await fetch('/api/config/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
    alert('Settings synced.');
    loadSettings();
}

async function deletePanel(id) {
    if(confirm('Delete panel?')) { await fetch(`/api/panels/${id}`, { method: 'DELETE' }); loadSettings(); }
}

function addNewPanelRow() {
    const body = document.getElementById('panels-body');
    const newId = "p" + (body.rows.length + 1).toString().padStart(2, '0');
    const row = body.insertRow();
    row.innerHTML = `
        <td><strong>${newId}</strong></td>
        <td><input type="text" class="p-name"></td>
        <td><input type="text" class="p-entity"></td>
        <td><input type="number" class="p-wp" value="400"></td>
        <td><input type="number" class="p-tilt" value="35"></td>
        <td><input type="number" class="p-azi" value="0"></td>
        <td style="text-align: center;"><button class="btn btn-green" onclick="savePanel('${newId}', this)">üíæ</button></td>`;
}

init();
</script>
</body>
</html>