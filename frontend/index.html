<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PV Panel Predictor</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; max-width: 1100px; }
    input, textarea { padding: 8px; width: 100%; margin: 6px 0 12px; box-sizing: border-box; }
    button { padding: 10px 12px; margin: 6px 8px 6px 0; cursor: pointer; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; align-items: start; }
    pre { background: #f6f8fa; padding: 12px; overflow: auto; border-radius: 10px; }
    .row { border: 1px solid #ddd; padding: 12px; border-radius: 12px; margin: 10px 0; }
    .muted { color: #666; font-size: 13px; }
    .small { font-size: 13px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; margin-left:8px; }
    .cols { display:grid; grid-template-columns: 2fr 3fr 1fr 1fr; gap: 10px; }
    .cols2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .hr { height:1px; background:#eee; margin: 14px 0; }
  </style>
</head>
<body>
  <h1>PV Panel Predictor <span class="pill">multi-panel</span></h1>
  <p class="muted">
    Beheer panelen (entity_id + tilt/azimuth) en train/predict per paneel of bulk.
    Open-Meteo azimuth: 0=Zuid, -90=Oost, +90=West, ±180=Noord.
  </p>

  <div class="grid">
    <div>
      <h2>Nieuw / Update paneel</h2>
      <div class="cols2">
        <div>
          <label>panel_id</label>
          <input id="panel_id" placeholder="panel_122030057513" />
        </div>
        <div>
          <label>scale_to_kwh (Wh→kWh = 0.001)</label>
          <input id="scale_to_kwh" value="0.001" />
        </div>
      </div>

      <label>entity_id</label>
      <input id="entity_id" value="sensor.inverter_122030057513_lifetime_energy_production" />

      <div class="cols2">
        <div>
          <label>tilt (deg)</label>
          <input id="tilt" value="35" />
        </div>
        <div>
          <label>azimuth (deg)</label>
          <input id="azimuth" value="0" />
        </div>
      </div>

      <div class="cols2">
        <div>
          <label>latitude</label>
          <input id="lat" placeholder="52.0" />
        </div>
        <div>
          <label>longitude</label>
          <input id="lon" placeholder="4.3" />
        </div>
      </div>

      <label>Home Assistant base URL</label>
      <input id="ha_url" placeholder="http://homeassistant.local:8123" />

      <label>Home Assistant long-lived token</label>
      <input id="ha_token" placeholder="eyJ0eXAiOiJKV1QiLCJh..." />

      <div>
        <button onclick="savePanel()">Opslaan</button>
        <button onclick="loadPanels()">Ververs</button>
        <button onclick="exportPanels()">Export JSON</button>
      </div>

      <div class="hr"></div>

      <h2>Import (28 panelen in 1 keer)</h2>
      <p class="muted small">
        Plak hier JSON array met panel configs. Voor ieder item minimaal: panel_id, entity_id, tilt_deg, azimuth_deg, latitude, longitude, ha_base_url, ha_token.
        scale_to_kwh is optioneel (default 0.001).
      </p>
      <textarea id="import_json" rows="10" placeholder='[{"panel_id":"p1","entity_id":"sensor...","tilt_deg":35,"azimuth_deg":0,"latitude":52.0,"longitude":4.3,"ha_base_url":"http://...","ha_token":"..."}]'></textarea>
      <button onclick="importPanels()">Import JSON</button>
    </div>

    <div>
      <h2>Bulk acties</h2>
      <button onclick="bulkTrain(30)">Train ALL (30d)</button>
      <button onclick="bulkTrain(365)">Train ALL (365d)</button>
      <button onclick="bulkPredict(7)">Predict ALL (7d)</button>
      <div class="hr"></div>

      <h2>Debug</h2>
      <pre id="debug"></pre>
    </div>
  </div>

  <h2>Panelen</h2>
  <div id="panels"></div>

<script>
function v(id){ return document.getElementById(id).value.trim(); }

async function loadPanels() {
  const r = await fetch('/api/panels');
  const j = await r.json();
  const el = document.getElementById('panels');
  el.innerHTML = '';
  (j.panels || []).forEach(p => {
    const div = document.createElement('div');
    div.className = 'row';
    div.innerHTML = `
      <div class="cols">
        <div><b>${p.panel_id}</b></div>
        <div class="small">${p.entity_id}</div>
        <div class="small">tilt: <b>${p.tilt_deg}</b>°</div>
        <div class="small">azi: <b>${p.azimuth_deg}</b>°</div>
      </div>
      <div class="muted small">lat/lon: ${p.latitude}, ${p.longitude} · HA: ${p.ha_base_url} · scale_to_kwh: ${p.scale_to_kwh ?? 0.001}</div>
      <div style="margin-top:10px;">
        <button onclick="train('${p.panel_id}', 30)">Train 30d</button>
        <button onclick="train('${p.panel_id}', 365)">Train 365d</button>
        <button onclick="predict('${p.panel_id}', 7)">Predict 7d</button>
        <button onclick="delPanel('${p.panel_id}')">Delete</button>
      </div>
    `;
    el.appendChild(div);
  });
  document.getElementById('debug').textContent = JSON.stringify(j, null, 2);
}

async function savePanel() {
  const payload = {
    panel_id: v('panel_id'),
    entity_id: v('entity_id'),
    tilt_deg: parseFloat(v('tilt')),
    azimuth_deg: parseFloat(v('azimuth')),
    latitude: parseFloat(v('lat')),
    longitude: parseFloat(v('lon')),
    ha_base_url: v('ha_url'),
    ha_token: v('ha_token'),
    scale_to_kwh: parseFloat(v('scale_to_kwh') || "0.001"),
  };
  const r = await fetch('/api/panels', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const j = await r.json();
  document.getElementById('debug').textContent = JSON.stringify(j, null, 2);
  await loadPanels();
}

async function delPanel(id) {
  await fetch(`/api/panels/${id}`, { method:'DELETE' });
  await loadPanels();
}

async function train(id, days) {
  const r = await fetch(`/api/panels/${id}/train?days=${days}`, { method:'POST' });
  const j = await r.json();
  document.getElementById('debug').textContent = JSON.stringify(j, null, 2);
}

async function predict(id, days) {
  const r = await fetch(`/api/panels/${id}/predict?days=${days}`);
  const j = await r.json();
  document.getElementById('debug').textContent = JSON.stringify(j, null, 2);
}

async function exportPanels() {
  const r = await fetch('/api/panels');
  const j = await r.json();
  const text = JSON.stringify(j.panels || [], null, 2);
  navigator.clipboard.writeText(text);
  document.getElementById('debug').textContent = "Exported panels JSON to clipboard.\n\n" + text;
}

async function importPanels() {
  let raw = document.getElementById('import_json').value;
  try {
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) throw new Error("Must be a JSON array");
    for (const p of arr) {
      // defaults
      if (p.scale_to_kwh === undefined) p.scale_to_kwh = 0.001;
      const r = await fetch('/api/panels', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(p) });
      const j = await r.json();
      if (!j.ok) throw new Error(JSON.stringify(j));
    }
    await loadPanels();
    document.getElementById('debug').textContent = "Import OK: " + arr.length + " panels";
  } catch(e) {
    document.getElementById('debug').textContent = "Import failed: " + e;
  }
}

async function bulkTrain(days) {
  const r = await fetch(`/api/train_all?days=${days}`, { method:'POST' });
  const j = await r.json();
  document.getElementById('debug').textContent = JSON.stringify(j, null, 2);
}

async function bulkPredict(days) {
  const r = await fetch(`/api/predict_all?days=${days}`);
  const j = await r.json();
  document.getElementById('debug').textContent = JSON.stringify(j, null, 2);
}

loadPanels();
</script>
</body>
</html>
