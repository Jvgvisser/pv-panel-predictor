<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV Predictor - Bartoutszate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a73e8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        
        .card { border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background: #fff; }
        .settings-card { background: #fdfdfd; border-left: 5px solid #1a73e8; margin-top: 30px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        
        input { padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 8px 12px; transition: 0.3s; }
        .btn-save { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-primary { background: #1a73e8; color: white; padding: 10px 20px; font-size: 1em; }
        button:hover { opacity: 0.8; }
        
        .chart-container { position: relative; height: 40vh; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚òÄÔ∏è PV Panel Predictor</h1>

    <div class="card">
        <h2>Totale Voorspelling (Vandaag & Morgen)</h2>
        <div class="chart-container">
            <canvas id="totalChart"></canvas>
        </div>
    </div>

    <div class="grid" style="margin-top:20px;">
        <div class="card">
            <h3>Status</h3>
            <p id="status-text">Data ophalen...</p>
        </div>
        <div class="card">
            <h3>Acties</h3>
            <button class="btn-primary" onclick="refreshData()">üîÑ Vernieuw Grafiek</button>
        </div>
    </div>

    <div class="card settings-card" id="settings-section">
        <h2>‚öôÔ∏è Systeem Instellingen</h2>
        
        <div class="grid">
            <div>
                <label>Home Assistant URL</label>
                <input type="text" id="ha_url" placeholder="http://192.168.1.xxx:8123">
            </div>
            <div>
                <label>Long-Lived Access Token</label>
                <input type="password" id="ha_token" placeholder="Plak token hier">
            </div>
        </div>
        <button class="btn-save" onclick="saveGlobalConfig()" style="width: 100%; margin-top: 10px;">üíæ HA Verbinding Opslaan voor alle panelen</button>

        <h3 style="margin-top: 30px;">Omvormers & Panelen Management</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Naam</th>
                    <th>HA Entity ID</th>
                    <th>Wp</th>
                    <th>Hoek</th>
                    <th>Azimut</th>
                    <th>Acties</th>
                </tr>
            </thead>
            <tbody id="panels-body"></tbody>
        </table>
        <button class="btn-primary" onclick="addNewPanelRow()" style="margin-top: 10px; background: #6c757d;">‚ûï Nieuw Paneel Toevoegen</button>
    </div>
</div>

<script>
let totalChart;

async function init() {
    await loadSettings();
    await refreshData();
}

async function loadSettings() {
    try {
        const configRes = await fetch('/api/config');
        const config = await configRes.json();
        document.getElementById('ha_url').value = config.ha_base_url || '';
        document.getElementById('ha_token').value = config.ha_token || '';

        const panelsRes = await fetch('/api/panels');
        const panels = await panelsRes.json();
        renderPanelsTable(panels);
        return panels;
    } catch (e) { console.error("Fout bij laden instellingen", e); }
}

function renderPanelsTable(panels) {
    const body = document.getElementById('panels-body');
    body.innerHTML = '';
    panels.forEach(p => {
        const row = body.insertRow();
        row.innerHTML = `
            <td><strong>${p.panel_id}</strong></td>
            <td><input type="text" class="p-name" value="${p.friendly_name || ''}"></td>
            <td><input type="text" class="p-entity" value="${p.entity_id}"></td>
            <td><input type="number" class="p-wp" value="${p.watt_peak || 400}"></td>
            <td><input type="number" class="p-tilt" value="${p.tilt_deg}"></td>
            <td><input type="number" class="p-azi" value="${p.azimuth_deg}"></td>
            <td>
                <button class="btn-save" onclick="savePanel('${p.panel_id}', this)">üíæ</button>
                <button class="btn-delete" onclick="deletePanel('${p.panel_id}')">üóëÔ∏è</button>
            </td>
        `;
    });
}

async function saveGlobalConfig() {
    const data = {
        ha_base_url: document.getElementById('ha_url').value,
        ha_token: document.getElementById('ha_token').value
    };
    const res = await fetch('/api/config/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    if(res.ok) alert('HA Instellingen bijgewerkt!');
}

async function savePanel(id, btn) {
    const row = btn.parentElement.parentElement;
    const data = {
        panel_id: id,
        friendly_name: row.querySelector('.p-name').value,
        entity_id: row.querySelector('.p-entity').value,
        watt_peak: parseFloat(row.querySelector('.p-wp').value),
        tilt_deg: parseFloat(row.querySelector('.p-tilt').value),
        azimuth_deg: parseFloat(row.querySelector('.p-azi').value),
        latitude: 52.0116,
        longitude: 4.3571,
        ha_base_url: document.getElementById('ha_url').value,
        ha_token: document.getElementById('ha_token').value,
        scale_to_kwh: 0.001
    };
    await fetch('/api/panels', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    alert('Paneel ' + id + ' opgeslagen!');
}

async function deletePanel(id) {
    if(confirm('Zeker weten?')) {
        await fetch(`/api/panels/${id}`, { method: 'DELETE' });
        loadSettings();
    }
}

function addNewPanelRow() {
    const body = document.getElementById('panels-body');
    const newId = "p" + (body.rows.length + 1).toString().padStart(2, '0');
    const row = body.insertRow();
    row.innerHTML = `
        <td><strong>${newId}</strong></td>
        <td><input type="text" class="p-name" value="Nieuw Paneel"></td>
        <td><input type="text" class="p-entity" value="sensor.naam"></td>
        <td><input type="number" class="p-wp" value="400"></td>
        <td><input type="number" class="p-tilt" value="35"></td>
        <td><input type="number" class="p-azi" value="0"></td>
        <td><button class="btn-save" onclick="savePanel('${newId}', this)">üíæ</button></td>
    `;
}

async function refreshData() {
    document.getElementById('status-text').innerText = "Berekenen...";
    const panels = await fetch('/api/panels').then(r => r.json());
    
    let totalForecast = {};

    for (const p of panels) {
        try {
            const res = await fetch(`/api/panels/${p.panel_id}/predict?days=2`);
            const data = await res.json();
            data.forecast.forEach(point => {
                totalForecast[point.time] = (totalForecast[point.time] || 0) + point.kwh;
            });
        } catch (e) { console.error("Fout bij paneel " + p.panel_id); }
    }

    const labels = Object.keys(totalForecast).sort();
    const values = labels.map(l => totalForecast[l]);

    updateChart(labels, values);
    document.getElementById('status-text').innerText = "Up-to-date";
}

function updateChart(labels, values) {
    const ctx = document.getElementById('totalChart').getContext('2d');
    
    // Formatteer labels naar leesbare tijd
    const timeLabels = labels.map(l => {
        const d = new Date(l);
        return d.getHours() + ":00 (" + d.getDate() + "-" + (d.getMonth()+1) + ")";
    });

    if (totalChart) totalChart.destroy();
    
    totalChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [{
                label: 'Totaal Voorspelling (kWh)',
                data: values,
                borderColor: '#1a73e8',
                backgroundColor: 'rgba(26, 115, 232, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'kWh' } }
            }
        }
    });
}

init();
</script>

</body>
</html>